name: Build oracle_fdw.dll

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout oracle_fdw
        uses: actions/checkout@v4

      - name: Install PostgreSQL 13
        run: |
          choco install postgresql13 --params '/Password=postgres' -y
          echo "C:\Program Files\PostgreSQL\13\bin" >> $env:GITHUB_PATH
          echo "C:\Program Files\PostgreSQL\13\include" >> $env:GITHUB_PATH
          echo "C:\Program Files\PostgreSQL\13\lib" >> $env:GITHUB_PATH

      - name: Install Oracle Instant Client (Basic + SDK)
        run: |
          choco install oracle-instantclient -y
          choco install oracle-instantclient-sdk -y
          echo "C:\tools\instantclient_19_18\sdk\include" >> $env:GITHUB_PATH
          echo "C:\tools\instantclient_19_18" >> $env:GITHUB_PATH

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build oracle_fdw
        run: |
          msbuild msvc/oracle_fdw.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:PGSQL="C:\Program Files\PostgreSQL\13" `
            /p:ORACLE_HOME="C:\tools\instantclient_19_18"

      - name: Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: oracle_fdw-dll
          path: msvc/x64/Release/oracle_fdw.dll
